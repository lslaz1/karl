<?xml version="1.0" encoding="utf-8"?>
<html xmlns="http://www.w3.org/1999/xhtml"
     xmlns:tal="http://xml.zope.org/namespaces/tal"
     xmlns:metal="http://xml.zope.org/namespaces/metal"
     metal:use-macro="api.community_layout">

  <div metal:fill-slot="content">
    <div class="chparent_wrapper">
      <a id="backto" class="chparent" href="${back_to_calendar_url}">
        <span class="glyphicon glyphicon-arrow-left icon"></span>
        Back to Calendar
      </a>
    </div>

    <div metal:use-macro="api.snippets.macros['status_message']"/>
    <div metal:define-macro="formerror"
	 tal:condition="fielderrors"
	 class="portalMessage">Please correct the indicated errors.</div>

    <h1 class="kscreentitle">Calendar Categories</h1>   
    <div class="setup_group">
      <p class="fieldHelp">
          Categories help to organize the calendar events within a community. 
      </p>
      
      <script language="javascript" type="text/javascript">
        //<![CDATA[
        $(document).ready(function(){
            
            $("#calendars").DataTable({
                columnDefs: [ 
                  { targets: 1, orderable: false } 
                ]
                paging: true,
                lengthChange: false,
                responsive: true,
                deferRender: true,
                scroller: true,
                searching: true,
            });

        });
        //]]>
      </script>

      <table id="calendars" class="table table-striped" cellspacing="0" tal:condition="editable_categories">
        <thead>
          <th>Name</th>
          <th>&nbsp;</th>
        </thead>
        <tbody>
          <tr tal:repeat="category editable_categories">
            <td class="name">${category.title}</td>
            <td class="actions text-right">
              <a class="edit_action" id="edit_${category.__name__}_category" href="#">edit</a> 
              <span class="separator">|</span> 
              <a class="delete_category_action" id="delete_category_${category.__name__}" href="#">delete</a>
            </td>
          </tr>
        </tbody>
      </table>

      <!-- Add a new category button -->
      <div class="add_button clearafter" id="setup_add_cal">
        <a class="btn btn-default" href="#"><span>Add Category</span></a>
      </div>

      <!-- Add a new category form -->
      <form id="setup_add_category_form" style="display: none" method="post" 
            action="${categories_url}" class="cal_add k3_genericForm"
            xml:id="contentform" enctype="multipart/form-data" name="save" >

        <h1>Add Category</h1>

        <fieldset tal:define="error (fielderrors_target == '__add_category__' and fielderrors['category_title'])|None"
                  class="calendar-categories-field ${error and 'fieldError' or ''}">
          <label for="category_title" class="required">Name the category</label><br />
          <div tal:condition="error" class="errorMessage fieldHelp">${error}</div> 
          <input name="category_title" class="input-sm form-control med-input" type="text" />
        </fieldset><br/>

        <fieldset id="submitcancel-field">
          <div class="buttons clearafter">
            <button id="form-submit" name="form.submitted" value="submit" type="submit" class="btn btn-default btn-sm"><span>Submit</span></button>
            <button id="form-cancel" name="form.cancel" value="cancel" type="submit" class="btn btn-default btn-sm"><span>Cancel</span></button>
          </div>
          <style type="text/css">
	    .required {
	    background-image: url(${api.static_url}/images/required.gif);
	    }
          </style>
        </fieldset>

      </form><br/>

      <!-- Edit each category forms -->
      <form tal:repeat="category editable_categories"
        id="edit_${category.__name__}_category_form" style="display: none" method="post" 
        action="${categories_url}" class="cal_edit k3_genericForm" 
        xml:id="contentform" enctype="multipart/form-data" name="save"> 

        <h1>Edit Category</h1>   

        <input name="category__name__" type="hidden" value="${category.__name__}" />

        <fieldset tal:define="error (fielderrors_target == ('%s_category' % category.__name__) and fielderrors['category_title'])|None"
                  class="calendar-categories-field ${error and 'fieldError' or ''}">
          <label for="category_title" class="required">Name the category</label><br />
          <div tal:condition="error" class="errorMessage fieldHelp">${error}</div> 
          <input name="category_title" class="form-control input-sm med-input" type="text" value="${category.title}" />
        </fieldset>

        <fieldset class="submitcancel-field">
          <div class="buttons clearafter"> 
            <button name="form.edit" type="submit" class="btn btn-default btn-sm"><span>Submit</span></button> 
            <button name="form.cancel" type="submit" class="btn btn-default btn-sm"><span>Cancel</span></button> 
          </div> 
        </fieldset>
      </form>

      <!-- Delete any category -->
      <form method="post" action="${categories_url}" id="cal_delete_category_form">
        <input type="hidden" name="form.delete" value="#" />
      </form>
    </div>

    <h1 class="kscreentitle">Calendar Layers</h1>   
    <div class="setup_group">
      <p class="fieldHelp">
        Layers are groupings of categories. Categories are not shown on the calendar directly. 
        Instead, they are grouped into layers and the layers are shown on the calendar. 
      </p>
      <table id="calendars" class="table table-striped" cellspacing="0" tal:condition="editable_layers">
        <tr>
          <th>&nbsp;</th>
          <th>Layer</th>
          <th>Categories</th>
          <th>&nbsp;</th>
        </tr>
        <tr tal:repeat="layer editable_layers">
          <td class="color"><div class="cal_${layer.color}_all">&nbsp;</div></td>
          <td class="name">${layer.title}</td>
          <td class="names">
            <tal:block repeat="category layer._v_categories">
               <span tal:replace="category['title']"/><br/>
            </tal:block>
            &nbsp;
          </td>
          <td class="actions text-right">
            <a class="edit_action" id="edit_${layer.__name__}_layer" href="#">edit</a>
            <span class="separator">|</span> 
            <a class="delete_layer_action" id="delete_layer_${layer.__name__}" href="#">delete</a>
          </td>
        </tr>
      </table>

      <!-- Add a new layer button -->  
      <div class="add_button clearafter" id="setup_add_layer">
        <a class="btn btn-default" href="#"><span>Add Layer</span></a>
      </div>

      <!-- Add a new layer form -->  
      <form id="setup_add_layer_form" style="display: none" method="post"
            action="${layers_url}" class="cal_add k3_genericForm" 
            xml:id="contentform" enctype="multipart/form-data" name="save">

        <h1>Add Layer</h1>

        <fieldset tal:define="error (fielderrors_target == '__add_layer__' and fielderrors['layer_title'])|None"
                  class="form-group categories-field ${error and 'fieldError' or ''}">
          <label for="layer_title" class="required">Name the layer</label><br />
          <div tal:condition="error" class="errorMessage fieldHelp">${error}</div> 
          <input name="layer_title" class="form-control input-sm med-input" type="text" />
        </fieldset>
      
        <fieldset tal:define="error (fielderrors_target == '__add_layer__' and fielderrors['category_paths'])|None"
                  class="form-group categories-field ${error and 'fieldError' or ''}">
          <label for="category_paths" class="required">Categories</label><br />
          <div tal:condition="error" class="errorMessage fieldHelp">${error}</div> 
          <table border="0" class="layers">
            <tr>
              <td>
                <select name="category_paths" class="form-control input-sm med-input">
                  <option tal:repeat="category all_categories"
                          value="${category['path']}">${category['title']}</option>
                </select>
              </td>
              <td><a class="remove" href="#" style="display: none;">Remove</a></td>
            </tr>
          </table>
          <a href="#" class="add" alt="Add Calendar">Add another category to this layer</a>
        </fieldset><br/>

        <fieldset tal:define="error (fielderrors_target == '__add_layer__' and fielderrors['layer_color'])|None"
                  class="form-group categories-field ${error and 'fieldError' or ''}">
          <label for="layer_color" class="required">Choose color</label><br />
          <div tal:condition="error" class="errorMessage fieldHelp">${error}</div> 

          <ul class="cal_choose_color">
            <li tal:repeat="color colors">
                <input name="layer_color"
                       type="radio" value="${color}" alt="${color}"/>
                <br/>
                <div class="cal_${color}_all">&nbsp;</div>
            </li>
          </ul>
        </fieldset>

        <fieldset id="submitcancel-field">
          <div class="buttons clearafter">
            <button id="form-submit" name="form.submitted" value="submit" type="submit" class="btn btn-default btn-sm"><span>Submit</span></button>
            <button id="form-cancel" name="form.cancel" value="cancel" type="submit" class="btn btn-default btn-sm"><span>Cancel</span></button>
          </div>
          <style type="text/css">
	    .required {
	    background-image: url(${api.static_url}/images/required.gif);
	    }
          </style>
        </fieldset>
      </form>

      <!-- Edit each layer forms -->  
      <form tal:repeat="layer editable_layers" style="display: none" method="post"
            id="edit_${layer.__name__}_layer_form" 
            action="${layers_url}" class="cal_edit k3_genericForm" 
            xml:id="contentform" enctype="multipart/form-data" name="save">

        <h1>Edit Layer</h1>

        <input name="layer__name__" type="hidden" value="${layer.__name__}" />

        <fieldset tal:define="error (fielderrors_target == ('%s_layer' % layer.__name__) and fielderrors['layer_title'])|None"
                  class="form-group categories-field ${error and 'fieldError' or ''}">
          <label for="layer_title" class="required">Name the layer</label><br />
          <div tal:condition="error" class="errorMessage fieldHelp">${error}</div> 
          <input name="layer_title" class="form-control input-sm med-input" type="text" value="${layer.title}" />
        </fieldset>
      
        <fieldset tal:define="error (fielderrors_target == ('%s_layer' % layer.__name__) and fielderrors['category_paths'])|None"
                  class="form-group categories-field ${error and 'fieldError' or ''}">
          <label for="calendar_path" class="required">Categories</label><br />
          <table border="0" class="layers">
            <tr tal:repeat="selected_category layer._v_categories">
              <td>
                <select name="category_paths" class="form-control input-sm">
                  <option tal:repeat="category all_categories"
                          value="${category['path']}"
                          selected="${selected_category['title'] == category['title']}">${category['title']}</option>
                </select>
              </td>
              <td><a class="remove" href="#" style="display: none;">Remove</a></td>
            </tr>

            <tr tal:condition="not(layer._v_categories)">
              <td>
                <select name="category_paths" class="form-control input-sm">
                  <option tal:repeat="category all_categories"
                          value="${category['path']}">${category['title']}</option>
                </select>
              </td>
              <td><a class="remove" href="#" style="display: none;">Remove</a></td>
            </tr>
          </table>
          <a href="#" class="add" alt="Add Calendar">Add another category to this layer</a>
        </fieldset>

        <fieldset tal:define="error (fielderrors_target == ('%s_layer' % layer.__name__) and fielderrors['layer_color'])|None"
                  class="form-group categories-field ${error and 'fieldError' or ''}">
          <label for="layer_color" class="required">Choose color</label><br />
          <div tal:condition="error" class="errorMessage fieldHelp">${error}</div> 

          <ul class="cal_choose_color">
            <li tal:repeat="color colors">
                <input name="layer_color"
                       type="radio" value="${color}" alt="${color}"
                       group="colors_${layer.__name__}" 
                       checked="${layer.color == color}"/>
                <br/>
                <div class="cal_${color}_all">&nbsp;</div>
            </li>
          </ul>
        </fieldset>

        <fieldset class="form-group submitcancel-field">
          <div class="buttons clearafter"> 
            <button name="form.edit" type="submit" class="btn btn-default"><span>Submit</span></button> 
            <button name="form.cancel" type="submit" class="btn btn-default"><span>Cancel</span></button> 
          </div> 
        </fieldset>  
      </form>

      <!-- Delete any layer -->
      <form method="post" action="${layers_url}" id="cal_delete_layer_form">
        <input type="hidden" name="form.delete" value="#" />
      </form>
    </div>

    <!-- Signal JavaScript with name of form with errors -->
    <form style="display: none">
      <input type="hidden" id="fielderrors_target" 
             name="fielderrors_target" value="${fielderrors_target}" />
    </form>

  </div>
</html>
